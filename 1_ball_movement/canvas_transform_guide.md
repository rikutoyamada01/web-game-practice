# Canvas座標変換入門：`save`, `restore`, `translate`, `rotate`

Canvasで複雑なアニメーションを作成する上で、座標変換は非常に強力なツールです。ここでは、特に重要な4つのメソッドについて、その仕組みと連携方法を解説します。

一言でいうと、これらのメソッドは**ペンを動かすのではなく、描画する「紙（座標系）」自体を動かしたり、回転させたりする**ためのものです。

---

## 各メソッドの解説

### 1. `ctx.translate(x, y)` - 座標系の「平行移動」

これは、座標系の原点 `(0, 0)` を、指定した `(x, y)` の位置に移動させるメソッドです。

- **イメージ:** 透明な方眼紙を、下の紙に対してスライドさせる感覚です。
- **効果:** `ctx.translate(50, 30);` を実行した後、`ctx.fillRect(0, 0, 10, 10);` で四角形を描画すると、実際の表示は元の座標の `(50, 30)` の位置に描画されます。

### 2. `ctx.rotate(angle)` - 座標系の「回転」

これは、座標系の原点 `(0, 0)` を中心に、座標系全体を指定した角度だけ回転させるメソッドです。

- **イメージ:** 透明な方眼紙の中心にピンを刺し、そのピンを軸に方眼紙を回転させる感覚です。
- **注意点:** 角度は**ラジアン単位**で指定します。度数から変換するには `角度 * Math.PI / 180` を使います。
- **組み合わせ:** `translate` と組み合わせることで、好きな位置を中心にして回転させることができます。

### 3. `ctx.save()` - 現在の状態を「セーブ」する

これは、その時点でのCanvasの**すべての描画状態**を保存するメソッドです。

- **保存される状態:**
    - 座標系の状態（`translate`による移動、`rotate`による回転など）
    - スタイル（`fillStyle`, `strokeStyle`, `lineWidth`など）
    - クリッピング領域
- **イメージ:** ゲームのセーブポイントのようなものです。現在の状態を「スタック」と呼ばれる場所に一時的に積み重ねて保存します。

### 4. `ctx.restore()` - 直前の状態を「ロード」する

これは、`save()`で最後に保存した状態を復元するメソッドです。

- **イメージ:** セーブポイントからロードする感覚です。「スタック」の一番上から状態を取り出し、現在のCanvasの状態をそれに置き換えます。
- **重要なルール:** `save()` と `restore()` は、必ず**ペアで使う**のが基本です。これにより、特定の描画のために加えた変更が、他の描画に影響を与えるのを防ぐことができます。

---

## 実践的な使い方 (太陽系の例)

`save()` と `restore()` を使うことで、各天体の描画を「独立」させることができます。地球を描画する際のステップを見てみましょう。

```javascript
// (原点はCanvasの中心に移動済みとする)

// 1. "太陽中心"のまっさらな状態を保存
ctx.save(); 

// 2. 地球の公転軌道に合わせて、座標系全体を回転
ctx.rotate(earthOrbitAngle);

// 3. 回転した座標系のX軸に沿って、軌道半径分離れた位置に原点を移動
ctx.translate(150, 0);

// 4. 新しい原点(地球の位置)に、地球の画像を描画
ctx.drawImage(earthImage, -earthImage.width / 2, -earthImage.height / 2);

// (もし月を描画するなら、ここでさらに save/restore の入れ子を作る)

// 5. 地球のために加えた変更をすべて破棄し、"太陽中心"の状態に戻す
ctx.restore(); 

// この後、もし火星を描画する場合でも、地球の回転や移動の影響を一切受けずに済む
```

### まとめ

複雑な描画を行う際の基本的なパターンは、以下のようになります。

1.  `ctx.save()` で、描画前の状態を保存する。
2.  `ctx.translate()` や `ctx.rotate()` を使って、描画したいモノに合わせた座標系を作る。
3.  新しい原点 `(0, 0)` を基準に、目的のモノを描画する。
4.  `ctx.restore()` を呼び出して、座標系やスタイルを元に戻す。

このパターンを繰り返すことで、どんなに複雑なシーンでも、各パーツを独立させてシンプルに描画していくことができます。
